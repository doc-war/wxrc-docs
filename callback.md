# 业务回调和场景

!>按场景需要向业务系统做异步通知。Last update：{docsify-updated} 

# 通用规范

## 通知地址

需要业务系统按响应规范提供API，WXRC会直接调用统一的{回调地址}

## 响应规范

WXRC客户端和业务系统（服务端）采用http通讯，数据发送为表单POST方式。返回数据JSON字符串。由请求地址不同控制访问不同的接口。报文的输入格式如reqHead、reqBody，输出resHead、resBody。按通知类型不同，所有回调的reqBody都会包含两个通用字段：botcode、type，其余字段不同类型的回调各有不同定义。

业务系统收到回调之后，resBody应响应一串字符{result：'success'}过来，表示收到，否则理论上WXRC应该继续按规则继续发起回调。考虑可能的异常，请注意用户消息类通知做幂等处理，避免打扰到用户。用于用户对响应体验的容忍是5秒以内，所以实际的原则上我们只回调一次，也暂无回调流水号区分，有异常请先群里吼。

header部分，无论请求头和请求体均无特殊附加处理。

# 登录场景和状态变更

* 场景说明

模拟客户端成功启动后会自动获取登录二维码，并在未登录状态下每隔120重置，都会发送二维码url，业务系统需要监听推码事件，并显示到用户前台。

当用户扫码后，微信上确认，微信服务端会进行验证，一部分账号因无法登陆报错，目前还不能很好的获取报错信息，但手机在用户手里，可以即时看到App页面错误展示，所以也无必要，故暂无此回调。我们没有提供退出登录API，也是相似的原因，因为微信App本身已天然提供，但我们需要将此事件通知给业务系统，以便前台正常维护登录状态。

已登录状态如业务系统下继续发起登录请求，WXRC并不会返回二维码，但会重新发送一条登录成功通知。

## 登录二维码推送{qrCode}

* WXRC的reqBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| botcode | string | 机器人编号，跟微信号一一对应，由原业务系统上送时定义，通用字段 |
| type | string | 回调类型，值见标题尾，通用字段 |
| qrcodeImageUrl | string | 最新的二维码图片下载地址 |

* 业务系统的resBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| result | string | ='success' |


## 登录状态通知{botStatus}

* WXRC的reqBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| botcode | string | 机器人编号，跟微信号一一对应，由原业务系统上送时定义，通用字段 |
| type | string | 回调类型，值见标题尾，通用字段 |
| botStatus | string | logout代表下线事件，login代表登录成功事件，loginerr代表登录失败，比如账号被限制web登录是广泛存在的,off代表机器人实例已注销 |

* 业务系统的resBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| result | string | ='success' |

# 用户消息转发

* 场景说明

目前我们暂只用一种场景，如果监听到at本机器人的消息，提取消息体和所在的群ID、消息发送人、转发给业务系统。我们不会等待业务系统的处理，业务系统的处理需要重新调用用户发送消息机器人接口。

## 转发At自己的消息{userMsg}

* WXRC的reqBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| botcode | string | 机器人编号，跟微信号一一对应，由原业务系统上送时定义，通用字段 |
| type | string | 回调类型，值见标题尾，通用字段 |
| msgType | string | 消息类型，暂时只有文本，='text' |
| msgdata | object | 如{text:'你好'}，后续随着消息类型的增加，会包括更多信息 |

* 业务系统的resBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| result | string | ='success' |

# 消息发送状态通知

出于风险规避考虑，我们后续会引入消息队列，当我们接收到来自业务系统的发送消息指令，我们先接收，最终发送成功后，我们会异步通知业务系统。

只推送已经发送成功的说法，代表WXRC系统向微信服务端请求发送成功，但实际达到用户端的时间取决于微信。

## 消息发送状态通知{sendStatus}

* WXRC的reqBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| botcode | string | 机器人编号，跟微信号一一对应，由原业务系统上送时定义，通用字段 |
| type | string | 回调类型，值见标题尾，通用字段 |
| msgid | Number | 原消息发送ID，前期木有 |

* 业务系统的resBody：

| 字段 | 类型 | 说明 |
|---|---|---|
| result | string | ='success' |